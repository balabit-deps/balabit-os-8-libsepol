Backport of: c49a8ea09501ad66e799ea41b8154b6770fec2c8 Mon Sep 17 00:00:00 2001
From: James Carter <jwcart2@gmail.com>
Date: Thu, 8 Apr 2021 13:32:06 -0400
Subject: PATCH] libsepol/cil: Check for statements not allowed in optional
 blocks

Index: libsepol-3.0/cil/src/cil_build_ast.c
===================================================================
--- libsepol-3.0.orig/cil/src/cil_build_ast.c
+++ libsepol-3.0/cil/src/cil_build_ast.c
@@ -50,6 +50,7 @@ struct cil_args_build {
 	struct cil_tree_node *ast;
 	struct cil_db *db;
 	struct cil_tree_node *macro;
+	struct cil_tree_node *optional;
 	struct cil_tree_node *boolif;
 	struct cil_tree_node *tunif;
 	struct cil_tree_node *in;
@@ -6103,6 +6104,7 @@ int __cil_build_ast_node_helper(struct c
 	struct cil_db *db = NULL;
 	struct cil_tree_node *ast_node = NULL;
 	struct cil_tree_node *macro = NULL;
+	struct cil_tree_node *optional = NULL;
 	struct cil_tree_node *boolif = NULL;
 	struct cil_tree_node *tunif = NULL;
 	struct cil_tree_node *in = NULL;
@@ -6117,6 +6119,7 @@ int __cil_build_ast_node_helper(struct c
 	db = args->db;
 	macro = args->macro;
 	boolif = args->boolif;
+	optional = args->optional;
 	tunif = args->tunif;
 	in = args->in;
 
@@ -6148,6 +6151,18 @@ int __cil_build_ast_node_helper(struct c
 		}
 	}
 
+	if (optional != NULL) {
+		if (parse_current->data == CIL_KEY_TUNABLE ||
+			parse_current->data == CIL_KEY_IN ||
+			parse_current->data == CIL_KEY_BLOCK ||
+			parse_current->data == CIL_KEY_BLOCKABSTRACT ||
+			parse_current->data == CIL_KEY_MACRO) {
+			rc = SEPOL_ERR;
+			cil_tree_log(parse_current, CIL_ERR, "%s is not allowed in optionals", (char *)parse_current->data);
+			goto exit;
+		}
+	}
+
 	if (boolif != NULL) {
 		if (parse_current->data != CIL_KEY_CONDTRUE &&
 			parse_current->data != CIL_KEY_CONDFALSE &&
@@ -6533,6 +6548,19 @@ int __cil_build_ast_last_child_helper(st
 		args->boolif = NULL;
 	}
 
+	if (ast->flavor == CIL_OPTIONAL) {
+		struct cil_tree_node *n = ast->parent;
+		args->optional = NULL;
+		/* Optionals can be nested */
+		while (n && n->flavor != CIL_ROOT) {
+			if (n->flavor == CIL_OPTIONAL) {
+				args->optional = n;
+				break;
+			}
+			n = n->parent;
+		}
+	}
+
 	if (ast->flavor == CIL_TUNABLEIF) {
 		args->tunif = NULL;
 	}
@@ -6566,6 +6594,7 @@ int cil_build_ast(struct cil_db *db, str
 	extra_args.ast = ast;
 	extra_args.db = db;
 	extra_args.macro = NULL;
+	extra_args.optional = NULL;
 	extra_args.boolif = NULL;
 	extra_args.tunif = NULL;
 	extra_args.in = NULL;
Index: libsepol-3.0/cil/src/cil_resolve_ast.c
===================================================================
--- libsepol-3.0.orig/cil/src/cil_resolve_ast.c
+++ libsepol-3.0/cil/src/cil_resolve_ast.c
@@ -3698,8 +3698,11 @@ int __cil_resolve_ast_node_helper(struct
 	}
 
 	if (optstack != NULL) {
-		if (node->flavor == CIL_TUNABLE || node->flavor == CIL_MACRO) {
-			/* tuanbles and macros are not allowed in optionals*/
+		if (node->flavor == CIL_TUNABLE ||
+			node->flavor == CIL_IN ||
+			node->flavor == CIL_BLOCK ||
+			node->flavor == CIL_BLOCKABSTRACT ||
+			node->flavor == CIL_MACRO) {
 			cil_tree_log(node, CIL_ERR, "%s statement is not allowed in optionals", cil_node_to_string(node));
 			rc = SEPOL_ERR;
 			goto exit;
